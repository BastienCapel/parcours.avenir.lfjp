import { useEffect, useMemo, useState } from "react";

const ROUTES = {
  HOME: "home",
  ORIENTATION_3E: "3eme",
};

function getCurrentHash() {
  if (typeof window === "undefined") return "";
  return window.location.hash || "";
}

function parseRouteFromHash(hash) {
  const normalized = (hash || "").replace(/^#\/?/, "").toLowerCase();
  if (normalized.startsWith("3")) return ROUTES.ORIENTATION_3E;
  return ROUTES.HOME;
}

function hashForRoute(route) {
  switch (route) {
    case ROUTES.ORIENTATION_3E:
      return "#/3eme";
    default:
      return "#/";
  }
}

// Page: Film annuel de l'orientation — 3e (LFJP)
// Single-file React component. TailwindCSS expected in host.
// Contrôles: recherche, filtres de période, bascule Tableau/Timeline, bouton Imprimer.

const DATA = [
  // Mieux se connaître
  {
    id: "enjeux-3e",
    phase: "Mieux se connaître",
    titre: "Présentation des enjeux de la 3e",
    details:
      "Objectifs de l'année, calendrier de l'orientation, attentes et livrables.",
    periode: "Septembre",
    ordre: 20250910,
    acteurs: ["PP", "PRIO", "Élèves"],
    lieu: "LFJP — Vie de classe",
  },
  {
    id: "bilan-competences",
    phase: "Mieux se connaître",
    titre: "Bilans de compétences (entretiens individuels)",
    details:
      "Identifier compétences scolaires et extra-scolaires. Aider à amorcer le projet.",
    periode: "Toute l'année",
    ordre: 20250915,
    acteurs: ["PRIO", "Élèves"],
    lieu: "Bureau orientation S9 / AP",
  },
  {
    id: "tests-interets",
    phase: "Mieux se connaître",
    titre: "Goûts et intérêts (tests ONISEP, Kledou)",
    details:
      "Exploration des intérêts et qualités. Restitution et pistes de métiers.",
    periode: "Septembre–Novembre",
    ordre: 20250920,
    acteurs: ["PRIO", "Élèves"],
    lieu: "Bureau orientation / AP",
  },
  {
    id: "autoportrait-slam",
    phase: "Mieux se connaître",
    titre: "Ateliers autoportrait — projet ‘Échos slamés de nos Avenirs’",
    details:
      "Production artistique avec Français/Arts/Musique et artistes locaux.",
    periode: "Septembre–Novembre",
    ordre: 20250925,
    acteurs: ["Français", "Arts", "Musique", "Artistes locaux"],
    lieu: "LFJP",
  },
  {
    id: "definition-parcours",
    phase: "Mieux se connaître",
    titre: "Définir le Parcours Avenir (brainstorming + oraux)",
    details:
      "Construction partagée des attendus et jalons de l'année.",
    periode: "Septembre–Octobre",
    ordre: 20250926,
    acteurs: ["Élèves", "PP", "PRIO"],
    lieu: "Heure de vie de classe",
  },
  {
    id: "prepa-stage",
    phase: "Mieux se connaître",
    titre: "Préparation et recherche du stage découverte",
    details:
      "Lettre de motivation, ciblage des entreprises, candidatures, simulation d'entretiens.",
    periode: "Septembre–Novembre",
    ordre: 20250927,
    acteurs: ["PRIO", "Élèves"],
    lieu: "Bureau orientation / AP",
  },
  {
    id: "forum-metiers",
    phase: "Mieux se connaître",
    titre: "Forum des Métiers (obligatoire) + restitution Slam",
    details: "Rencontres avec professionnels. Valorisation des productions.",
    periode: "29 novembre",
    ordre: 20251129,
    acteurs: ["Professionnels", "PP", "PRIO"],
    lieu: "LFJP",
  },
  {
    id: "info-parents",
    phase: "Mieux se connaître",
    titre: "Info parents — voies post‑3e, calendrier, procédure",
    details:
      "Présentation Bac général / Bac pro / CAP. Calendrier et affectation.",
    periode: "11 novembre",
    ordre: 20251111,
    acteurs: ["PP", "PRIO"],
    lieu: "LFJP",
  },
  {
    id: "info-eleves",
    phase: "Mieux se connaître",
    titre: "Info élèves — cap sur l'orientation",
    details: "Questions/réponses. Organisation Forum et stage.",
    periode: "Novembre",
    ordre: 20251120,
    acteurs: ["PRIO", "Élèves"],
    lieu: "Vie de classe",
  },

  // Plonger dans le monde professionnel
  {
    id: "stage-decouverte",
    phase: "Plonger dans le monde professionnel",
    titre: "Stage de découverte en entreprise",
    details: "Découverte d'un milieu professionnel. Observation et prise de notes.",
    periode: "15–19 décembre",
    ordre: 20251215,
    acteurs: ["Élèves"],
    lieu: "Entreprise",
  },
  {
    id: "suivi-stage",
    phase: "Plonger dans le monde professionnel",
    titre: "Suivi de stage et accompagnement",
    details: "Point d'étape individuel pendant le stage si nécessaire.",
    periode: "Décembre (à la demande)",
    ordre: 20251217,
    acteurs: ["PP", "Équipe pédagogique", "PRIO"],
    lieu: "LFJP / Entreprise",
  },
  {
    id: "rapport-stage",
    phase: "Plonger dans le monde professionnel",
    titre: "Rédaction du rapport de stage",
    details: "Structuration, analyse d'expérience, mise en forme.",
    periode: "Dès décembre",
    ordre: 20251220,
    acteurs: ["PP", "PRIO"],
    lieu: "Bureau orientation / AP",
  },
  {
    id: "soutenance-stage",
    phase: "Plonger dans le monde professionnel",
    titre: "Aide à la soutenance orale",
    details: "Préparation diaporama, posture, grille d'évaluation.",
    periode: "Dès décembre",
    ordre: 20251222,
    acteurs: ["PRIO"],
    lieu: "Bureau orientation",
  },
  {
    id: "mini-stages",
    phase: "Plonger dans le monde professionnel",
    titre: "Mini‑stages CAP/Bac Pro pour profils ciblés",
    details: "Immersions courtes dans des lycées pro pour affiner le projet.",
    periode: "À la demande (dès décembre)",
    ordre: 20251223,
    acteurs: ["PP", "PRIO", "CPE"],
    lieu: "Établissements partenaires",
  },
  {
    id: "ouverture-pro",
    phase: "Plonger dans le monde professionnel",
    titre: "Découverte d'entreprises locales et écoles",
    details: "Visites, interventions, témoignages de professionnels.",
    periode: "Toute l'année",
    ordre: 20260110,
    acteurs: ["Équipe pédagogique", "PP", "PRIO"],
    lieu: "LFJP / Extérieurs",
  },

  // Finaliser les projets
  {
    id: "suivi-affectation",
    phase: "Finaliser les projets",
    titre: "Suivi individuel et procédures d'affectation",
    details: "Consolider le projet des élèves vers voies techno/pro ou générale.",
    periode: "Mars–Juin",
    ordre: 20260310,
    acteurs: ["PP", "PRIO", "CPE", "Parents"],
    lieu: "LFJP",
  },
  {
    id: "affelnet",
    phase: "Finaliser les projets",
    titre: "AFFELNET — finalisation et saisie",
    details: "Accompagnement à la saisie et vérifications finales.",
    periode: "Mai–fin juin",
    ordre: 20260520,
    acteurs: ["PRIO"],
    lieu: "LFJP",
  },
];

const PHASES = [
  { key: "Mieux se connaître", color: "bg-sky-100 border-sky-300" },
  { key: "Plonger dans le monde professionnel", color: "bg-emerald-100 border-emerald-300" },
  { key: "Finaliser les projets", color: "bg-amber-100 border-amber-300" },
];

export default function ParcoursAvenirApp() {
  const [route, setRoute] = useState(() => parseRouteFromHash(getCurrentHash()));

  useEffect(() => {
    if (typeof window === "undefined") return;
    const handleHashChange = () => setRoute(parseRouteFromHash(window.location.hash));
    window.addEventListener("hashchange", handleHashChange);
    return () => window.removeEventListener("hashchange", handleHashChange);
  }, []);

  const navigate = (targetRoute) => {
    if (typeof window === "undefined") {
      setRoute(targetRoute);
      return;
    }
    const targetHash = hashForRoute(targetRoute);
    if (window.location.hash !== targetHash) {
      window.location.hash = targetHash;
    } else {
      setRoute(targetRoute);
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900">
      {route === ROUTES.ORIENTATION_3E ? (
        <Orientation3ePage onNavigateHome={() => navigate(ROUTES.HOME)} />
      ) : (
        <HomePage onNavigate3e={() => navigate(ROUTES.ORIENTATION_3E)} />
      )}
    </div>
  );
}

function HomePage({ onNavigate3e }) {
  const stageHref = hashForRoute(ROUTES.ORIENTATION_3E);

  const handleClick = (event) => {
    event.preventDefault();
    onNavigate3e?.();
  };

  return (
    <div className="mx-auto flex max-w-5xl flex-col gap-12 px-6 py-16">
      <section className="text-center">
        <p className="text-xs font-semibold uppercase tracking-[0.2em] text-sky-600">Parcours Avenir · LFJP</p>
        <h1 className="mt-4 text-3xl font-semibold tracking-tight sm:text-4xl">Construire son avenir avec confiance</h1>
        <p className="mt-4 text-base leading-relaxed text-slate-700">
          Le Parcours Avenir aide chaque collégien du Lycée Français Jean-Pierre à mieux se connaître,
          à explorer le monde professionnel et à construire un projet d'orientation ambitieux et réaliste.
          Il articule ateliers, rencontres et accompagnements personnalisés pour que les élèves gagnent en
          autonomie tout au long du collège.
        </p>
        <p className="mt-3 text-base leading-relaxed text-slate-700">
          Ce dispositif est orchestré par notre professeure référente à l'information et à l'orientation,
          <strong className="font-semibold"> Mme D'Aquino</strong>. Grâce à son expertise et à son écoute,
          elle coordonne les équipes, suit chaque élève avec attention et fait du Parcours Avenir un levier
          de réussite pour toute la communauté éducative.
        </p>
        <div className="mt-8 flex justify-center">
          <a
            href={stageHref}
            onClick={handleClick}
            className="inline-flex items-center gap-2 rounded-full bg-sky-600 px-6 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2"
          >
            Explorer l'étape 3e
            <span aria-hidden>→</span>
          </a>
        </div>
      </section>

      <section className="grid gap-6 md:grid-cols-3">
        <article className="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-100">
          <h2 className="text-lg font-semibold text-slate-900">Mieux se connaître</h2>
          <p className="mt-2 text-sm leading-relaxed text-slate-700">
            Des bilans personnels, des ateliers créatifs et des entretiens individuels pour identifier ses
            talents, ses motivations et ce qui fait sens pour chaque élève.
          </p>
        </article>
        <article className="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-100">
          <h2 className="text-lg font-semibold text-slate-900">Plonger dans le monde professionnel</h2>
          <p className="mt-2 text-sm leading-relaxed text-slate-700">
            Stages, forums des métiers et rencontres de professionnels ouvrent des horizons et donnent
            des repères concrets pour imaginer l'avenir.
          </p>
        </article>
        <article className="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-100">
          <h2 className="text-lg font-semibold text-slate-900">Finaliser son projet</h2>
          <p className="mt-2 text-sm leading-relaxed text-slate-700">
            Un accompagnement serré sur les procédures, les choix de voies et la préparation des dossiers
            pour transformer l'ambition en projet abouti.
          </p>
        </article>
      </section>

      <section className="rounded-2xl border border-slate-200 bg-white/70 p-6 text-left shadow-sm">
        <h2 className="text-lg font-semibold text-slate-900">Le focus 3e</h2>
        <p className="mt-2 text-sm leading-relaxed text-slate-700">
          L'année de 3e est une étape clé : on y consolide son projet, on expérimente le monde du travail
          et on prépare l'affectation au lycée. Retrouvez l'intégralité du film annuel de l'orientation en
          suivant le lien ci-dessus.
        </p>
      </section>
    </div>
  );
}

function classNames(...xs) {
  return xs.filter(Boolean).join(" ");
}

function normalize(str) {
  return (str || "").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "");
}

function Orientation3ePage({ onNavigateHome }) {
  const [q, setQ] = useState("");
  const [phase, setPhase] = useState("all");
  const [view, setView] = useState("timeline"); // timeline | table
  const homeHref = hashForRoute(ROUTES.HOME);

  const filtered = useMemo(() => {
    const nq = normalize(q);
    return DATA.filter((d) =>
      (phase === "all" || d.phase === phase) &&
      (
        nq === "" ||
        normalize(d.titre).includes(nq) ||
        normalize(d.details).includes(nq) ||
        normalize(d.periode).includes(nq) ||
        normalize(d.acteurs.join(" ")).includes(nq)
      )
    ).sort((a, b) => a.ordre - b.ordre);
  }, [q, phase]);

  const grouped = useMemo(() => {
    const map = new Map();
    for (const item of filtered) {
      if (!map.has(item.phase)) map.set(item.phase, []);
      map.get(item.phase).push(item);
    }
    return Array.from(map.entries()).sort(
      (a, b) => PHASES.findIndex((p) => p.key === a[0]) - PHASES.findIndex((p) => p.key === b[0])
    );
  }, [filtered]);

  const printPage = () => {
    if (typeof window !== "undefined") {
      window.print();
    }
  };

  return (
    <div className="mx-auto max-w-7xl p-6">
      <div className="mb-4">
        <a
          href={homeHref}
          onClick={(event) => {
            event.preventDefault();
            onNavigateHome?.();
          }}
          className="inline-flex items-center gap-2 text-sm font-medium text-sky-700 hover:text-sky-900"
        >
          <span aria-hidden>←</span>
          Retour à l'accueil
        </a>
      </div>
      <header className="mb-6 flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 className="text-2xl font-semibold tracking-tight">Film annuel de l'orientation — 3e</h1>
          <p className="text-sm text-slate-600">LFJP · Parcours Avenir · Année scolaire 2025‑2026</p>
        </div>
        <div className="flex flex-wrap items-center gap-2">
          <div className="flex items-center gap-2">
            <label className="text-sm text-slate-600" htmlFor="view">Vue</label>
            <select
              id="view"
              value={view}
              onChange={(e) => setView(e.target.value)}
              className="rounded-xl border px-3 py-2 text-sm"
            >
              <option value="timeline">Timeline</option>
              <option value="table">Tableau</option>
            </select>
          </div>
          <div className="flex items-center gap-2">
            <label className="text-sm text-slate-600" htmlFor="phase">Phase</label>
            <select
              id="phase"
              value={phase}
              onChange={(e) => setPhase(e.target.value)}
              className="rounded-xl border px-3 py-2 text-sm"
            >
              <option value="all">Toutes</option>
              {PHASES.map((p) => (
                <option key={p.key} value={p.key}>{p.key}</option>
              ))}
            </select>
          </div>
          <input
            type="search"
            placeholder="Rechercher titre, période, acteurs..."
            value={q}
            onChange={(e) => setQ(e.target.value)}
            className="w-64 rounded-xl border px-3 py-2 text-sm"
          />
          <button onClick={printPage} className="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50">
            Imprimer / PDF
          </button>
        </div>
      </header>

      {view === "timeline" ? (
        <Timeline grouped={grouped} />
      ) : (
        <TableView rows={filtered} />)
      }

      <footer className="mt-8 border-t pt-4 text-xs text-slate-500">
        Données issues du canevas Parcours Avenir 3e. Dernière mise à jour: {new Date().toISOString().slice(0,10)}.
      </footer>
    </div>
  );
}

function Timeline({ grouped }) {
  return (
    <div className="flex flex-col gap-8">
      {grouped.map(([title, items]) => {
        const phaseMeta = PHASES.find((p) => p.key === title);
        return (
          <section key={title}>
            <h2 className="mb-3 text-lg font-semibold">{title}</h2>
            <div className="relative pl-6">
              {/* Axis */}
              <div className="absolute left-2 top-0 h-full w-px bg-slate-200" aria-hidden />
              <ul className="space-y-4">
                {items.map((it) => (
                  <li key={it.id} className="relative">
                    <div className="absolute -left-1.5 top-2 h-3 w-3 rounded-full bg-white ring-2 ring-slate-300" aria-hidden />
                    <article className={classNames("rounded-2xl border p-4", phaseMeta?.color)}>
                      <div className="flex flex-wrap items-baseline justify-between gap-2">
                        <h3 className="font-medium">{it.titre}</h3>
                        <span className="text-xs text-slate-700">{it.periode}</span>
                      </div>
                      <p className="mt-1 text-sm text-slate-700">{it.details}</p>
                      <div className="mt-2 flex flex-wrap gap-2 text-xs text-slate-600">
                        <Badge icon="users" label={it.acteurs.join(", ")} />
                        <Badge icon="map-pin" label={it.lieu} />
                        <Badge icon="flag" label={it.phase} />
                      </div>
                    </article>
                  </li>
                ))}
              </ul>
            </div>
          </section>
        );
      })}
    </div>
  );
}

function TableView({ rows }) {
  return (
    <div className="overflow-hidden rounded-2xl border">
      <table className="min-w-full divide-y divide-slate-200">
        <thead className="bg-slate-50">
          <tr>
            <Th>Phase</Th>
            <Th>Période</Th>
            <Th>Titre</Th>
            <Th>Détails</Th>
            <Th>Acteurs</Th>
            <Th>Lieu</Th>
          </tr>
        </thead>
        <tbody className="divide-y divide-slate-100 bg-white">
          {rows.map((r) => (
            <tr key={r.id} className="hover:bg-slate-50">
              <Td className="whitespace-nowrap text-slate-700">{r.phase}</Td>
              <Td className="whitespace-nowrap text-slate-700">{r.periode}</Td>
              <Td className="font-medium">{r.titre}</Td>
              <Td className="text-slate-700">{r.details}</Td>
              <Td className="text-slate-700">{r.acteurs.join(", ")}</Td>
              <Td className="text-slate-700">{r.lieu}</Td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

function Th({ children }) {
  return (
    <th scope="col" className="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-600">
      {children}
    </th>
  );
}
function Td({ children, className }) {
  return <td className={"px-4 py-3 text-sm " + (className || "")}>{children}</td>;
}

function Badge({ icon, label }) {
  return (
    <span className="inline-flex items-center gap-1 rounded-full bg-white/70 px-2 py-1 text-[11px] ring-1 ring-slate-300">
      <Icon name={icon} className="h-3 w-3" />
      <span>{label}</span>
    </span>
  );
}

function Icon({ name, className }) {
  // Minimal inline icon set to avoid external deps
  const paths = {
    users: "M17 20v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2M7 10a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm10-3a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z",
    "map-pin": "M12 21s-6-5.686-6-10a6 6 0 1 1 12 0c0 4.314-6 10-6 10Zm0-8a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z",
    flag: "M4 15V3a1 1 0 0 1 1-1h10l-1 3 4 .5V15l-4-.5-1 3H5a1 1 0 0 1-1-1Z",
  };
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
      <path d={paths[name] || paths.flag} />
    </svg>
  );
}
